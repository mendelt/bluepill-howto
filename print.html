<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bluepill Rust HowTo</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction and Setup</a></li><li><ol class="section"><li class="expanded "><a href="setup_hardware.html"><strong aria-hidden="true">1.1.</strong> Hardware setup</a></li><li class="expanded "><a href="setup_software.html"><strong aria-hidden="true">1.2.</strong> Software installation</a></li></ol></li><li class="expanded "><a href="blink.html"><strong aria-hidden="true">2.</strong> Blink a led</a></li><li><ol class="section"><li class="expanded "><a href="project_setup.html"><strong aria-hidden="true">2.1.</strong> Project setup</a></li><li class="expanded "><a href="debugging.html"><strong aria-hidden="true">2.2.</strong> Run in the debugger</a></li><li class="expanded "><a href="programming.html"><strong aria-hidden="true">2.3.</strong> Programming the board</a></li><li class="expanded "><a href="semihosting.html"><strong aria-hidden="true">2.4.</strong> Text output with semihosting</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="links.html">Links</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Bluepill Rust HowTo</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction-and-setup" id="introduction-and-setup">Introduction and Setup</a></h1>
<p>This document describes how to use the Rust programming language to write firmware for the bluepill board. It is assumed that Linux is used on the host used for development and debugging.
We'll use an STLink II compatible programmer for programming and debugging.</p>
<h1><a class="header" href="#hardware-setup" id="hardware-setup">Hardware setup</a></h1>
<h2><a class="header" href="#bluepill-board" id="bluepill-board">Bluepill board</a></h2>
<p>The blue pill board is an inexpensive stm32f103 based microcontroller board that is available from many resellers. It is inexpensive and relatively powerful so it's
perfect for learning. The stm32f103 comes with plenty of I/O, decent amounts of flash and RAM memory and is quite fast.</p>
<h2><a class="header" href="#stlink-v2-or-equivalent" id="stlink-v2-or-equivalent">STLink v2 or equivalent</a></h2>
<p>The STLink v2 is a USB programmer and debugger for the stm32 range of microcontrollers by STMicroelectronics. The STLink itself is not expensive but even cheaper
imitations can be bought that will also do the job.</p>
<h2><a class="header" href="#connect-your-hardware" id="connect-your-hardware">Connect your hardware</a></h2>
<p>TODO: Describe how to connect the stlink and the board</p>
<h1><a class="header" href="#software-installation" id="software-installation">Software installation</a></h1>
<p>This paragraph describes setting up the tools used to program and debug the BluePill board. We'll use the normal Rust tools to write and compile software. Cargo, Rust's
build tool can cross-compile to target other targets out-of-the-box. We'll just need to add the right build target for the stm32 on the Bluepill board.
We'll use GDB and OpenOCD to connect to our target hardware for programming and debugging.</p>
<h2><a class="header" href="#rust-cargo-and-rustup" id="rust-cargo-and-rustup">Rust, Cargo and Rustup</a></h2>
<p>We'll assume you already have a working and up-to-date Rust setup on your machine. If not a description on how to install it can be found in the <a href="https://doc.rust-lang.org/book/ch01-01-installation.html">official Rust book</a>. To cross compile sofware for the stm32f103 microcontroller on the bluepill board the additional target <code>thumbv7m-none-eabi</code> needs to be added. This can be done with the following command;</p>
<pre><code>rustup target add thumbv7m-none-eabi
</code></pre>
<h2><a class="header" href="#openocd" id="openocd">OpenOCD</a></h2>
<p>We'll need OpenOCD to be able to connect to your device so we can program and debug it. A recent (0.10.0 is the newest at the time of writing this document) version can
probably be installed using the package manager of your choice.
on Debian based systems this can be done this way;</p>
<pre><code>sudo apt-get install openocd
</code></pre>
<p>On arch or manjaro this will do the trick;</p>
<pre><code>sudo pacman -S openocd
</code></pre>
<h2><a class="header" href="#gdb" id="gdb">GDB</a></h2>
<p>GDB is the Gnu debugger. There is a special version for debugging Arm devices that we can use to remotely connect to the blue pill and step though your code. There is
probably a package for your package manager available that can be installed similar to this;</p>
<pre><code>sudo apt-get install arm-none-eabi-gdb
</code></pre>
<p>or</p>
<pre><code>sudo pacman -S arm-none-eabi-gdb
</code></pre>
<blockquote>
<p>If the <code>arm-none-eabi-gdb</code> package does not exist in your package manager it might be that you're using a system based on Ubuntu 18.04 or later. where this package
was replaced by the gdb-multiarch package;</p>
<pre><code>sudo apt-get install gdb-multiarch
</code></pre>
<p>Keep in mind that in later chapters you will need to specify a different debugger in some scripts.</p>
</blockquote>
<p>Now that we have all the prerequisites set up we can start programming. In the next chapter we'll show how easy it is to create our first embedded software to blink
a led.</p>
<h1><a class="header" href="#blink-a-led" id="blink-a-led">Blink a led</a></h1>
<p>In this chapter we will walk through a simle but complete project from start to finish. We will first set up a Rust project to target the stm32 on the bluepill board. We will create a simple program to blink a led. Then we will demonstrate how to build the code and program the board and we will show how to run the program in a debugger.</p>
<h1><a class="header" href="#project-setup" id="project-setup">Project setup</a></h1>
<p>This chapter shows you step by step how to set up a rust project to target the bluepill (or other embedded) target. This is a great way to introduce all the separate parts of a project and explain them bit-by-bit. </p>
<blockquote>
<h2><a class="header" href="#the-easy-way" id="the-easy-way">The easy way</a></h2>
<p>If you just want to get started programming you can also use cargo generate to use the bluepill-template
project. This will set all this up for you instead of you having to type it all in manually.
Cargo generate can be installed with the following command;</p>
<pre><code>cargo install cargo-generate
</code></pre>
<p>You can then start a new project;</p>
<pre><code>cargo generate --git https://github.com/mendelt/bluepill-template
</code></pre>
</blockquote>
<p>You can create a project the same way you do for normal Rust programs using cargo new;</p>
<pre><code>cargo new hello-stm32
</code></pre>
<p>This will initialize a directory with a simple project for you.</p>
<p>We will need to tell cargo to use the <code>thumbv7m-none-eabi</code> target among other things. To do this you can create a new text-file in the .cargo folder in your project
directory called <code>.cargo/config</code> with the following contents;</p>
<pre><code>[build]
target = &quot;thumbv7m-none-eabi&quot;

[target.thumbv7m-none-eabi]
runner = &quot;arm-none-eabi-gdb -q -x openocd.gdb&quot;
# runner = &quot;gdb-multiarch -q -x openocd.gdb&quot;

rustflags = [
    &quot;-C&quot;,
    &quot;link-arg=-Tlink.x&quot;
]
</code></pre>
<p>This will tell cargo to use the thumbv7m-none-eabi target for our project by default. The next section in the file configures some flags for the rust compiler and tells
cargo it should use the gdb debugger for our platform to run our software instead of trying to start compiled programs itself. This will allow us to use the <code>cargo run</code>
command to start debugging on our target system.</p>
<blockquote>
<p>If you installed the <code>gdb-multiarch</code> package instead of <code>arm-none-eabi-gdb</code> in the previous chapter you will need to comment out the runner line and un-comment the next line in this file to make this work for you.</p>
</blockquote>
<p>There is one other file that you will need and thats a linker script to tell the linker about the layout of the memory of our target.
Create a file in the project root called <code>memory.x</code> for this. It should contain the following text;</p>
<pre><code>/* Linker script for the STM32F103C8T6 */
MEMORY
RY
{
  FLASH : ORIGIN = 0x08000000, LENGTH = 64K
  RAM : ORIGIN = 0x20000000, LENGTH = 20K
}
</code></pre>
<p>Now we are ready to create our first program by editing <code>src/main.rs</code></p>
<pre><code>#![no_main]
#![no_std]

#[allow(unused_imports)]
use panic_semihosting;

use cortex_m_rt::{entry};
use cortex_m_semihosting::hprintln;

#[entry]
fn main() -&gt; ! {
    hprintln!(&quot;Hello semihosting world&quot;);

    loop { }
}
</code></pre>
<p>First the lines with <code>#![no_main]</code> and <code>#![no_std]</code> tell the compiler how we want to set up the
program. ``#![no_main]<code>tells the compiler that there is no main function like in a normal rust program. We use the</code>cortex_m_rt<code>crate that provides a light-weight runtime for our embedded code. We do have an</code>fn main()<code>but that could be named anything. We use the</code>#[entry]<code>annotation to tell the runtime what the entry point to our code is.</code>#![no_std]<code>simply tells the compiler not to add the Rust</code>std<code>crate. The</code>std<code>crate depends on a lot of primitives that are normally supplied by the operating system of our computer. We do not have an operating system to supply things like threading or file-io so we use</code>#![no_std]<code>to tell the compiler to use the Rust</code>core` crate instead.</p>
<p>TODO: explain panic_semihosting
TODO: imports
TODO: explain _peripherals and _device
TODO: rewrite to blinky
TODO: explain loop</p>
<p>To make this program work we need to add the dependencies we used to Cargo.toml</p>
<pre><code>[dependencies]
cortex-m = &quot;0.6.2&quot;
cortex-m-rt = &quot;0.6.11&quot;
cortex-m-semihosting = &quot;0.3.5&quot;
panic-semihosting = &quot;0.5.3&quot;

[dependencies.hal]
package = &quot;stm32f1xx-hal&quot;
version = &quot;0.5.3&quot;
features = [&quot;rt&quot;, &quot;stm32f103&quot;, &quot;medium&quot;]
</code></pre>
<p>TODO: fix dependencies.hal
TODO: explain dependencies</p>
<h1><a class="header" href="#runing-code-in-the-debugger" id="runing-code-in-the-debugger">Runing code in the debugger</a></h1>
<p>This document will show you two ways of getting code to run on the bluepill. Eventually the code should be compiled to a <code>.hex</code> file that can be distributed and flashed
onto your board. But this won't be the way you program your board during development. During development it will be more useful to have a tight deployment and test cycle
where you can incrementally write your code, compile it and test it out. Also it will be useful to be able to debug your code to quickly find and solve problems.
In this chapter we'll show you how to set up your project to quickly use <code>cargo run</code> to build and deploy your program to your board using <code>openocd</code> and the <code>gdb</code> debugger.</p>
<p>First we need to set up a script to start <code>openocd</code> and connect to your stlink in-circuit-debugger. We described how to connect this debugger to your board at the start of this book.</p>
<pre><code>#!/bin/sh
openocd -f interface/stlink-v2.cfg -f target/stm32f1x.cfg
</code></pre>
<p>next we'll set up cargo to use gdb as runner when starting our application. We do this by creating a <code>.cargo</code> directory at the root level in our project and creating the file <code>.cargo/config</code> with the following content.</p>
<pre><code>[target.thumbv7m-none-eabi]
runner = &quot;arm-none-eabi-gdb -q -x openocd.gdb&quot;
# runner = &quot;gdb-multiarch -q -x openocd.gdb&quot;

rustflags = [
    &quot;-C&quot;,
    &quot;link-arg=-Tlink.x&quot;
]

[build]
target = &quot;thumbv7m-none-eabi&quot;
</code></pre>
<p>This file first configures the <code>thumbv7m-none-eabi</code> target, the target for our platform, to use gdb as the runner using the file <code>openocd.gdb</code> with some initial commands.
We'll create this file shortly.</p>
<p>After this it specifies some flags for the linker and it configures the right default target.</p>
<p>If you installed gdb-multiarch in the previous chapter you'll need to comment out the runner line and replace it with the line below it.</p>
<p>Now we'll add the <code>openocd.gdb</code> file with some convenient set-up commands for gdb whenever we run our code. It should look a bit like this but you can customize it later;</p>
<pre><code>target remote :3333
set print asm-demangle on
monitor arm semihosting enable

# detect unhandled exceptions, hard faults and panics
break DefaultHandler
break HardFault
break rust_begin_unwind

load
</code></pre>
<p>TODO: expand on this file and explain commands.</p>
<p>Now that you've set this up you should be able to compile and run your code. You do this by first starting <code>openocd</code> by running the script we created earlier; <code>./openocd.sh</code>. Preferably run this in a separate terminal. You can just leave this running when you're developing, so you'll only need to start this once.</p>
<p>Running your code should be as easy as running <code>cargo run</code> in your project directory.</p>
<h1><a class="header" href="#programming-the-bluepill" id="programming-the-bluepill">Programming the bluepill</a></h1>
<h1><a class="header" href="#text-output-with-semihosting" id="text-output-with-semihosting">Text output with Semihosting</a></h1>
<h1><a class="header" href="#links" id="links">Links</a></h1>
<p>A collection of resources on Embedded and Rust programming</p>
<p><a href="https://github.com/rust-embedded/awesome-embedded-rust">Amazing Embedded Rust</a>
<a href="https://rust-embedded.github.io/discovery/">Discovery</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
